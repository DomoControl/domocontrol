<!DOCTYPE html>
<html>
<head>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
    <meta name="robots" content="noindex" />
    <title>Domus Control</title>
    <link href="./css/style.css" rel="stylesheet" type="text/css">
    <script type="text/javascript" src="/webiopi.js"></script>
    <script type="text/javascript"> 
        var Interval = null; 

        //Ciclo principale
        webiopi().ready(function(){
            getLangDict1();
            //~ alert('qui');

        });
        
        function getLangDict1(){
            if(getCookies()['language']==undefined){var language='en';}else{var language=getCookies()['language'];}
            webiopi().callMacro("getLangDict", language , getLangDict); 
        }
        
        var getLangDict = function (macro, args, response) {
            //~ alert(response);
            //~ var res = eval(response);
            var res = $.parseJSON(response);
            LANG = res;
            //~ alert('===>>>'+JSON.stringify(LANG));
            getPage();
        }
        
        //return translation terms
        function L(tag){
            //~ alert('===>>>'+JSON.stringify(tag));
            var l = LANG[tag];
            if(l==undefined){
                //~ alert('termine da tradurre:'+tag);
                langAdd(tag);
                return d(tag);
            }
            else{
                //~ alert('qui');
                return d(l); //return translate term
            }
        }

        //Set LOG into database
        function logt(page) {
            //~ webiopi().callMacro("setLogt", [page,codehelper_ip.IP]);
            webiopi().callMacro("setLogt", [page,'----']);
        }
        
        //Funzione che trasforma i cookie in array
        function getCookies() {
            var cookies = { }; 
            if (document.cookie && document.cookie != '') {
                var split = document.cookie.split(';');
                for (var i = 0; i < split.length; i++) {
                    var name_value = split[i].split("=");
                    name_value[0] = name_value[0].replace(/^ /, '');
                    cookies[decodeURIComponent(name_value[0])] = decodeURIComponent(name_value[1]);
                }
            }	  
            return cookies;   
        }                
        
        //Return datetime
        function NOW(){return new Date();}
        
        //Set Cookie
        function setCookies(name,value,id){
            if(!value){name='page'; value='login';}
            if(name=='page'){
                var date = NOW();
                var session_timeout = getCookies()['session_timeout'];
                date.setTime(date.getTime() + (session_timeout * 60 * 1000));
                document.cookie = name+"="+value + '; expires=' + date.toUTCString() + '; path=/';
            } else {
                document.cookie = name+"="+value;
            }
            if(!id){id = 1;}
            return id;
        }
        
        //~ to show help (button ?)
        function h(help){
            var f = '<input type="button" name="help" value="?" onclick=(alert(\"'+help+'\")); class="textbox-300" />';
            return f;
        }
        
        
        
        //Sceglie quali pagine mostrare
        function getPage(id) {
            var title=''; var footer='';
            var page = getCookies()['page'];
            //~ setCookies('page',page);
            if(typeof(page) == 'undefined' || page == '""') {setCookies('page','login'); getPage(1);} //init if page is not set
            //~ alert(document.cookie);
            logt(page); //Send LOG
            if (page != 'menuStatus'){stopInterval();}
            switch(page) {
                case 'login':
                    //~ alert('Login');
                    title += '<small>'+L('login')+'</small>';
                    footer += '<span>'+L('insert_username_and_password')+'</span>';
                    var f = '<form id="login">';
                    f +=            '<fieldset>';
                    f +=                '<p><center>'+L('login_message')+'</center></p>'
                    f +=                '<p><label class="field" for="Username">'+L('username')+'</label><input id="username" type=text name="username" value="" required autofocus class="textbox-300"></p>';
                    f +=                '<p><label class="field" for="Password">'+L('password')+'</label><input id="password" type=password name="password" value="" required class="textbox-300"></p>';
                    f +=                '<p><label class="field" for="Entra">&nbsp;</label><input id="entra" type="button" name="entra" value="'+L('login')+'" onclick=Login();  class="textbox-300"></p>';
                    f +=            '</fieldset>';
                    f +=    '</form>';
                    $("#form").html(f);
                    break;
                case 'menu':
                    //~ alert('Menu');
                    title += '<small>Menu</small>'
                    footer += '<span><input type="button" name="footer" value="'+L('logout')+'" onclick=LogOut() ></span>' ;
                    footer += '<span>'+L('welcome')+' ' + getCookies()["username"] + '</span>';   
                    var f = '';
                    f += '<p class="but"><input type="button" name="status" value="Status" onclick="setCookies(\'page\',\'menuStatus\'); getPage(1)" ></p>';
                    //privilege
                    if(getCookies()['privilege1']==1 || getCookies()['privilege3']==1 || getCookies()['privilege4']==1){
                        f += '<p class="but"><input type="button" name="setup" value="Setup" onclick="setCookies(\'page\',\'menuSetup\');getPage(1)" ></p>'; 
                    }
                    $("#form").html(f);                  
                    $("#form1").html('');
                    break;
				case 'menuStatus':
                    //~ alert('MenuSetup');
                    title += '<small>'+L('status')+'</small>';
                    footer += '<span><input type="button" name="footer" value="'+L('logout')+'" onclick=LogOut() ></span>' ;
                    footer += '<input type="button" name="setup" value="Menu" onclick="setCookies(\'page\',\'menu\'); stopInterval(); getPage(1)" >';
                    footer += '<span>'+L('welcome')+' ' + getCookies()["username"] + '</span>'; 
                    stopInterval();
                    startStatus();
                    
                    $("#form").html('')
                    $("#form1").html('');
                    break;
                case 'menuSetup':
                    //~ alert('MenuSetup');
                    title += '<small>'+L('setup')+'</small>';
                    footer += '<span><input type="button" name="footer" value="'+L('logout')+'" onclick=LogOut() ></span>' ;
                    footer += '<span><input type="button" name="footer" value="'+L('main_menu')+'" onclick="setCookies(\'page\',\'menu\');getPage(1)" ></span>' ;
                    footer += '<span>'+L('welcome')+' ' + getCookies()["username"] + '</span>';   
                    var f = '';  
                    //privilege
                    if(getCookies()['privilege4']==1){
                        f += '<p class="but"><input type="button" name="setup" value="User Setup" onclick="setCookies(\'page\',\'userSetup\');getPage(1)" ></p>';
                    }
                    f += '<p class="but"><input type="button" name="setup" value="Area Setup" onclick="setCookies(\'page\',\'areaSetup\');getPage(1)" ></p>';
                    f += '<p class="but"><input type="button" name="setup" value="Group Privilege" onclick="setCookies(\'page\',\'privilegeSetup\');getPage(1)" ></p>';
                    f += '<p class="but"><input type="button" name="setup" value="Lang Setup" onclick="setCookies(\'page\',\'langSetup\');getPage(1)" ></p>';
                    f += '<p class="but"><input type="button" name="setup" value="Board Type" onclick="setCookies(\'page\',\'boardTypeSetup\');getPage(1)" ></p>';
                    f += '<p class="but"><input type="button" name="setup" value="Board Setup" onclick="setCookies(\'page\',\'boardSetup\');getPage(1)" ></p>';
                    f += '<p class="but"><input type="button" name="setup" value="Input Setup" onclick="setCookies(\'page\',\'inputSetup\');getPage(1)" ></p>';
                    f += '<p class="but"><input type="button" name="setup" value="Type Setup" onclick="setCookies(\'page\',\'typeSetup\');getPage(1)" ></p>';
                    f += '<p class="but"><input type="button" name="setup" value="Program Setup" onclick="setCookies(\'page\',\'programSetup\');getPage(1)" ></p>';
                    f += '<p class="but"><input type="button" name="setup" value="Email - SMS Setup" onclick="setCookies(\'page\',\'email-smsSetup\');getPage(1)" ></p>';
                    $("#form").html(f)
                    $("#form1").html('');
                    break;
                case 'userSetup':
                    //~ alert('UserSetup');
                    title += '<small>User Setup</small>';
                    footer += '<span><input type="button" name="footer" value="LogOut" onclick=LogOut() ></span>' ;
                    footer += '<input type="button" name="setup" value="Menu Setup" onclick="setCookies(\'page\',\'menuSetup\');getPage(1)" >';
                    footer += '<span>Benvenuto ' + getCookies()["username"] + '</span>';
                    //~ alert(getCookies()['user_id'] + document.cookie);
                    webiopi().callMacro("getUser", getCookies()['user_id'] , getUser);
                    $("#form").html('');
                    $("#form1").html('');
                    break;                        
                case 'areaSetup':
                    //~ alert('AreaSetup');
                    title += '<small>Area Setup</small>';
                    footer += '<span><input type="button" name="footer" value="LogOut" onclick=LogOut() ></span>' ;
                    footer += '<input type="button" name="setup" value="Menu Setup" onclick="setCookies(\'page\',\'menuSetup\');getPage(1)" >';
                    footer += '<span>Benvenuto ' + getCookies()["username"] + '</span>';
                    webiopi().callMacro("setArea", '' , setArea);
                    $("#form").html('');
                    $("#form1").html('');
                    break;  
                case 'langSetup':
                    //~ alert('AreaSetup');
                    title += '<small>Lang Setup</small>';
                    footer += '<span><input type="button" name="footer" value="LogOut" onclick="LogOut();getPage();" ></span>' ;
                    footer += '<input type="button" name="setup" value="Menu Setup" onclick="setCookies(\'page\',\'menuSetup\');getPage(1)" >';
                    footer += '<span>Benvenuto ' + getCookies()["username"] + '</span>';
                    webiopi().callMacro("getLang", '' , getLang);
                    $("#form").html('');
                    $("#form1").html('');
                    break;
                case 'privilegeSetup':
                    //~ alert('PrivilegeSetup');
                    title += '<small>Group Privileges</small>';
                    footer += '<span><input type="button" name="footer" value="LogOut" onclick=LogOut() ></span>' ;
                    footer += '<input type="button" name="setup" value="Menu Setup" onclick="setCookies(\'page\',\'menuSetup\');getPage(1)" >';
                    footer += '<span>Benvenuto ' + getCookies()["username"] + '</span>';
                    webiopi().callMacro("setPrivilege", '' , setPrivilege);
                    $("#form").html('');
                    $("#form1").html('');
                    break;   
                case 'inputSetup':
                    //~ alert('InputSetup');
                    title += '<small>Input Setup</small>';
                    footer += '<span><input type="button" name="footer" value="LogOut" onclick=LogOut() ></span>' ;
                    footer += '<input type="button" name="setup" value="Menu Setup" onclick="setCookies(\'page\',\'menuSetup\');getPage(1)" >';
                    footer += '<span>Benvenuto ' + getCookies()["username"] + '</span>';
                    webiopi().callMacro("setInputSetup", '' , setInputSetup);
                    $("#form").html('');
                    $("#form1").html('');
                    break; 
                case 'boardTypeSetup':
                    //~ alert('BoardType');
                    title += '<small>Board Type Setup</small>';
                    footer += '<span><input type="button" name="footer" value="LogOut" onclick=LogOut() ></span>' ;
                    footer += '<input type="button" name="setup" value="Menu Setup" onclick="setCookies(\'page\',\'menuSetup\');getPage(1)" >';
                    footer += '<span>Benvenuto ' + getCookies()["username"] + '</span>';
                    webiopi().callMacro("boardTypeSetup", '' , boardTypeSetup);
                    $("#form").html('');
                    $("#form1").html('');
                    break; 
                case 'boardSetup':
                    //~ alert('BoardSetup');    
                    title += '<small>Board Setup</small>';
                    footer += '<span><input type="button" name="footer" value="LogOut" onclick=LogOut() ></span>' ;
                    footer += '<input type="button" name="setup" value="Menu Setup" onclick="setCookies(\'page\',\'menuSetup\');getPage(1)" >';
                    footer += '<span>Benvenuto ' + getCookies()["username"] + '</span>';
                    webiopi().callMacro("setBoardSetup", '' , setBoardSetup);
                    $("#form").html('');
                    $("#form1").html('');
                    break;                        
                case 'boardIOSetup':
                    //~ alert('*****BoardIOSetup*****');
                    title += '<small>Board IO Setup</small>';
                    footer += '<span><input type="button" name="footer" value="LogOut" onclick=LogOut() ></span>' ;
                    footer += '<input type="button" name="setup" value="Menu Setup" onclick="setCookies(\'page\',\'menuSetup\');getPage(1)" >';
                    footer += '<input type="button" name="setup" value="Board Setup" onclick="setCookies(\'page\',\'boardSetup\');getPage(1)" >';
                    footer += '<span>Benvenuto ' + getCookies()["username"] + '</span>';
                    webiopi().callMacro("setBoardIOSetup", getCookies()["board_id"] , setBoardIOSetup);
                    $("#form").html('');
                    $("#form1").html('');
                    break;   
                case 'areaSetup':
                    //~ alert('AreaSetup');
                    title += '<small>Area Setup</small>';
                    footer += '<span><input type="button" name="footer" value="LogOut" onclick=LogOut() ></span>' ;
                    footer += '<input type="button" name="setup" value="Menu Setup" onclick="setCookies(\'page\',\'menuSetup\');getPage(1)" >';
                    footer += '<span>Benvenuto ' + getCookies()["username"] + '</span>';
                    $("#form").html('');
                    $("#form1").html('');
                    break;
                case 'typeSetup':
                    //~ alert('TypeSetup');    
                    title += '<small>Type Function Setup</small>';
                    footer += '<span><input type="button" name="footer" value="LogOut" onclick=LogOut() ></span>' ;
                    footer += '<input type="button" name="setup" value="Menu Setup" onclick="setCookies(\'page\',\'menuSetup\');getPage(1)" >';
                    footer += '<span>Benvenuto ' + getCookies()["username"] + '</span>';
                    webiopi().callMacro("setType", '' , setType);
                    $("#form").html('');
                    $("#form1").html('');
                    break;
                case 'programSetup':
                    //~ alert('ProgramSetup');    
                    title += '<small>Program Setup</small>';
                    footer += '<span><input type="button" name="footer" value="LogOut" onclick=LogOut() ></span>' ;
                    footer += '<input type="button" name="setup" value="Menu Setup" onclick="setCookies(\'page\',\'menuSetup\');getPage(1)" >';
                    footer += '<input type="button" name="setup" value="Menu Status" onclick="setCookies(\'page\',\'menuStatus\');getPage(1)" >';
                    footer += '<span>Benvenuto ' + getCookies()["username"] + '</span>';
                    webiopi().callMacro("programSetup", '', programSetup);
                    $("#form").html('');
                    break;                        
                case 'email-smsSetup':
                    //~ alert('EmailSetup');
                    title += '<small>Email - SMS Setup</small>';
                    footer += '<span><input type="button" name="footer" value="LogOut" onclick=LogOut() ></span>' ;
                    footer += '<input type="button" name="setup" value="Menu Setup" onclick="setCookies(\'page\',\'menuSetup\');getPage(1)" >';
                    footer += '<span>Benvenuto ' + getCookies()["username"] + '</span>';
                    $("#form").html('');
                    $("#form1").html('');
                    break;
                default:
                    //~ alert('Default');
                    setCookies('page','login',1);
                    getPage();
                    break;
            } 
            
            //get language flag
            if(getCookies()['language']=='en'){flag='<image src="images/en_flag.png" width="25px" />';}
            else{flag='<image src="images/it_flag.png" width="25px" />';}
            $("#title").html('<h1>'+L('domocontrol')+' - ' + title + ' '+ flag +'</h1>');
            
            $("#footer").html(footer);
        }
        
        function startStatus(){
            Interval = setInterval(function(){
                webiopi().callMacro("getMenuStatus", '', getMenuStatus);
            },1000);
        }
        
        function stopInterval(){
            clearInterval(Interval);
            interval=null;
        }
        
        var getMenuStatus = function (macro, args, response) {
                if(response=='uguale'){
                    f = status;
                }
                else {
					var res = $.parseJSON(response);
                    
					if (res['equal'] != 'equal'){}
					var f = "<div class='status'><table width=100%>";
                    
					for(r in res['program']){
                        //~ text += JSON.stringify(res['program'][r]['in_id']);
						f += "<tr><td id='title'colspan=5>"+d(res['program'][r]['description'])+"&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;"+d(res['type'][res['program'][r]['type_id']]['name'])+"</td></tr>";    
						f += "<tr><td>"+d(res['board_io'][res['program'][r]['in_id']]['description'])+"</td><td>Inverted</td><td>"+d(res['board_io'][res['program'][r]['out_id']]['description'])+"</td><td>Edit</td></tr>";
                        
                        //Input
                        if(res['program'][r]['type_id'] == 3 ){
                            f += '<td>';
                        }
                        if(res['program'][r]['type_id'] != 3 && res['program'][r]['IN'] == 1 && res['board_io'][res['program'][r]['in_id']]['address'] > '0'){
                            f += '<td><img src="./images/in_off.png" width="60px" />';
                        }
                        else if(res['program'][r]['type_id'] != 3 && res['program'][r]['IN'] == 0 && res['board_io'][res['program'][r]['in_id']]['address'] > '0'){
                            f += '<td><img src="./images/in_on.png" width="60px" />';
                        }
                        else if(res['program'][r]['type_id'] != 3 && res['program'][r]['IN'] == 1 && res['board_io'][res['program'][r]['in_id']]['address'] == '0'){
                            f += '<td><input type="image" src="./images/in_push_off.png" width="60px" name="IN" value="'+res['program'][r]['IN']+'" onclick=\'invertInput('+r+')\'; />';
                        }
                        else if(res['program'][r]['type_id'] != 3 && res['program'][r]['IN'] == 0 && res['board_io'][res['program'][r]['in_id']]['address'] == '0'){
                            f += '<td><input type="image" src="./images/in_push_on.png" width="60px" name="IN" value="'+res['program'][r]['IN']+'" onclick=\'invertInput('+r+')\'; />';
                        }
                        
                        if(res['program'][r]['type_id'] == 2){ //Show timer conter
                            if('TIMER' in res['program'][r]){f += "<br>"+res['program'][r]['TIMER']+" sec";}
                            else{
                                t = res['program'][r]['timer'].split(';');
                                f += "<br>D:h:m:s "+t[0]+":"+t[1]+":"+t[2]+":"+t[3];
                            }
                        }
                        else if(res['program'][r]['type_id'] == 3){ //Show CHRONO
                            t = res['program'][r]['chrono'].split(';');
                            t = t.filter(function(n){ return n != ""});
                            //~ alert(JSON.stringify(t))
                            var tc='From - To<br>';                            
                            for(rc in t){
                                var cfh = t.shift();
                                var cfm = t.shift();
                                var cfs = t.shift();
                                var cth = t.shift();
                                var ctm = t.shift();
                                var cts = t.shift();
                                
                                tc += (cfh.length < 2 ? '0':'') + cfh +':' + (cfm.length < 2 ? '0':'') + cfm +':' + (cfs.length < 2 ? '0':'') + cfs + ' - ';
                                tc += (cth.length < 2 ? '0':'') + cth +':' + (ctm.length < 2 ? '0':'') + ctm +':' + (cts.length < 2 ? '0':'') + cts;
                                tc += '<br>';
                                //~ tc += 'From:'+t.shift()+':'+t.shift()+':'+t.shift()+' to:'+t.shift()+':'+t.shift()+':'+t.shift()+'<br>';
                            }
                            
                            //~ var myNumber = 7;
                            //~ ("0" + myNumber).slice(-2);
                            
                            
                            f += tc;
                        }
                        f += "</td>";
                    
						if(res['program'][r]['inverted'] == 1){var check = 'checked';} else {var check = '';}
						f += "<td><input type='checkbox' name='inverted' "+check+" /></td>";
						//~ f += "<td>"+res['program'][r]['in_delay']+"</td>";
                    
						if(res['program'][r]['OUT'] == 1){var out_image = 'out_on.png'}else{var out_image = 'out_off.png'}
						f += "<td><input type='image' src='./images/"+out_image+"' height='40px' name='OUT' value='"+res['program'][r]['OUT']+"' /></td>";                   
						f += "<td><input type='button' value='Edit' onclick=\"setCookies(\'page\',\'programSetup\');getPage(1)\" /></td>";
						f += "</tr>";
					
                    }
                    f += "</table></div>";
                    status = f;	
                
				}
               //var now = NOW();
               //now = now.toLocaleFormat('%H:%M:%S');
               //$("#datetime").html(now);
                $("#form").html(f); 
                
        }
        
        //~ To invert INPUT
        function invertInput(id){ 
            //~ alert(id);
            webiopi().callMacro("invertInput", id);
            //~ alert(getCookies()['page']);
            getPage();
        }
        
        
        //verifica se le credenziali sono corrette
        function Login() {
            if($("#username").val() && $("#password").val()) {
                //~ alert([$("#username").val(),$("#password").val()]);
                webiopi().callMacro("setLogin", [$("#username").val(),$("#password").val()], setLogin);
            }
            else {
                alert(L('insert_username_and_password'));
            }
        } 
        
        //Ritorna i dati dell'utente che vengono salvati
        var setLogin = function (macro, args, response) {
            //~ alert(response);
            if(response == "Login_NO") {
                alert("Username e Password non validi");    
            } else {
                var res = $.parseJSON(response);
                //~ alert(res['user'][0]['name'])
                setCookies('page','menu',1);
                setCookies('user_id',res['user'][0]['id'],1);
                setCookies('username',res['user'][0]['username'],1);
                setCookies('name',res['user'][0]['name'],1);
                setCookies('surname',res['user'][0]['surname'],1);
                setCookies('session_timeout',res['user'][0]['session'],1);
                setCookies('language',res['user'][0]['lang'],1);
                
                for (r in res['user'][0]['privilege']){
                    setCookies('privilege'+res['user'][0]['privilege'][r],'1');
                }
                getPage();
            }
        }
        
        //rimuove i cookie e logout
        function LogOut() {
            //remove all cookies
            var cookies = document.cookie.split(";");
            for(var i=0; i < cookies.length; i++) {
                var equals = cookies[i].indexOf("=");
                var name = equals > -1 ? cookies[i].substr(0, equals) : cookies[i];
                document.cookie = name + "=;expires=Thu, 01 Jan 1970 00:00:00 GMT";
            }
            setCookies('page','login');
            //~ alert(getCookies()['page']);
            getPage();
        }
        
        //Pagine setupUseralert(id);
        var getUser = function (macro, args, response) {
            var res = eval(response);
            f = '<form name="setUserForm" id="setUserForm" onsubmit="checkEntries()">';
            f += '<table width=100%>';
            f +=    '<input type="hidden" name="id" value="'+ res[0][0]['id'] +'" class="textbox-300" >';
            f +=     '<tr><td style="text-align:right;">'+L('username')+'</td><td><input type="text" name="username" value="'+ d(res[0][0]['username']) +'" class="textbox-300" /></td></tr>';
            f +=     '<tr><td style="text-align:right;">'+L('password')+'</td><td><input id="password" type="password" name="password" value="'+ res[0][0]['password'] +'" required class="textbox-300" ></td></tr>';
            f +=     '<tr><td style="text-align:right;">'+L('retype_password')+'</td><td><input id="confirmPassword" type="password" name="confirmPassword" value="" class="textbox-300"></td></tr>';
            f +=     '<tr><td style="text-align:right;">'+L('name')+'</td><td><input type="text" name="name" value="'+ d(res[0][0]['name']) +'" class="textbox-300" ></td></tr>';
            f +=     '<tr><td style="text-align:right;">'+L('surname')+'</td><td><input type="text" name="surname" value="'+ d(res[0][0]['surname']) +'" class="textbox-300" ></td></tr>';
            //Checkbox language
            f += '<tr><td style="text-align:right;">'+L('language')+'</td><td style="text-align:left;"><select id="lang" name="lang" title="Select Language" >';
                var sel = '';
                var lang={'en':L('english'),'it':L('italian')};
                for(l in lang) {
                    var lang_selected = '';
                    if( res[0][0]['lang'] == l ){lang_selected='selected=selected';}
                    f += '<option value="'+l+'" '+lang_selected+' >'+ lang[l] +'</option>';
                }
            f += '</select></td></tr>';
            //end checkbox
            f +=     '<tr><td style="text-align:right;">'+L('session_timeout')+'</td><td style="text-align:left;" ><input type="number" name="session" value="'+ d(res[0][0]['session']) +'" class="textbox-300" min=10 max=4000>minute</td></tr>';
            res[0][0]['active'] ? checked='checked="checked"' : checked=''; 
            //Checkbox privilege
            var c = ''; var checked; var admin='';
            for(var k in res[1]) {
                checked = '';
                var pp = []; pp = res[0][0]['privilege'].split(';');
                for (var priv in pp) {
                    //~ $("#message").append(res[1][k]['id'] + ' - ' + pp[priv] +'<br>');
                    if (res[1][k]['id'] == pp[priv]) {
                        checked = 'checked="checked"';
                    }
                    if(res[1][k]['id']==4){admin='yes';}
                }
                f += '<tr><td style="text-align:right;">'+L(res[1][k]['name'])+'</td><td><input type="checkbox" id="privilege" name="privilege[]" value="'+d(res[1][k]['id'])+'" '+ checked +' class="textbox-300" /></td></tr>';
            }
            //end checkbox
            f +=            '<tr><td>&nbsp;</td><td><input id="valida" type="button" name="'+L('save')+'" value="Save" onclick=setUserSave();  class="textbox-300">';
            if(admin=='yes'){
                f += '<input type="button" id="add" name="add" value="'+L('add_user')+'" onclick="addUserSetup();"; /></td></tr>';
            }else{f += '</td></tr>';}
            f += '</table>';
            
            if(admin=='yes'){
                f += '<table width=100% ><caption style="font-weight:bold; background-color:#2952D8; color:white; margin-top:20px;">'+L('users_privileges')+'</caption>';
                f += '<tr><th>'+L('username')+'</th><th>'+L('name')+'</th><th>'+L('surname')+'</th><th>'+L('password')+'</th><th></th></tr>';
                for(var z in res[2]) {
                    f += '<input type="hidden" id="setUserId'+res[2][z]['id']+'" name="setUserId'+res[2][z]['id']+'" value="'+res[2][z]['id']+'" />';
                    f += '<tr><td><input style="width:60px;" type="text" id="setUserUsername'+res[2][z]['id']+'" name="setUserUsername'+res[2][z]['id']+'" value="'+res[2][z]['username']+'" /></td>';
                    f += '<td><input style="width:100px;" type="text" id="setUserName'+res[2][z]['id']+'" name="setUserName'+res[2][z]['id']+'" value="'+res[2][z]['name']+'" /></td>';
                    f += '<td><input style="width:100px;" type="text" id="setUserSurname'+res[2][z]['id']+'" name="setUserSurname'+res[2][z]['id']+'" value="'+res[2][z]['surname']+'" /></td>';
                    f += '<td><input style="width:100px;" type="password" id="setUserPassword'+res[2][z]['id']+'" name="setUserPassword'+res[2][z]['id']+'" value="'+res[2][z]['password']+'" /></td>';
                    f += '<td><input type="button" name="edit" value="Edit" onclick="setCookies(\'page\',\'userSetup\'); editUserSetup('+res[2][z]['id']+');" />';
                    f += '<input type="button" name="del" value="Del" onclick="setCookies(\'page\',\'userSetup\'); delUserSetup('+res[2][z]['id']+');" /></td>';
                    
                    //Checkbox privilege
                    //~ alert(JSON.stringify(res[2][z]))
                    f += '<tr></tr></table>';
                    
                    f += '<div id="setUser'+res[2][z]['id']+'"><table width=100%><tr>';
                    for(var setUserP in res[1]) {
                        var setUserChecked = '';
                        if( res[2][z]['privilege'].indexOf(res[1][setUserP]['id'].toString())> -1 ){setUserChecked = 'checked="checked"';}
                        
                        f += '<td>'+L(res[1][setUserP]['name']);
                        f += '<div id="setU'+res[2][z]['id']+'"><input type="checkbox" id="setUserPrivilege'+res[2][z]['id']+'" name="setUserPrivilege" value="'+res[1][setUserP]['id']+'" '+ setUserChecked +' /></div></td>';
                    }
                    f += '</tr></table></td></tr>';
                    //end checkbox
                    f += '<tr><td colspan=10><hr></td></tr>'
                }
            }
            f += '</table></div>';
            f += '</form>';                  
            //~ alert(f);
            //~ alert(JSON.stringify(res[1]));
            $("#form").html(f);
        }
        
        function editUserSetup(id){
            r = '';
            r += 'id='+ $('#setUserForm').find('input[name="setUserId'+id+'"]').val();
            r += ',username='+ $('#setUserForm').find('input[name="setUserUsername'+id+'"]').val();
            r += ',name='+ $('#setUserForm').find('input[name="setUserName'+id+'"]').val();
            r += ',surname='+ $('#setUserForm').find('input[name="setUserSurname'+id+'"]').val();
            if($('#setUserForm').find('input[name="setUserPassword'+id+'"]').val()==='undefined'){alert('Inserisci la password');return;}
            r += ',password='+ $('#setUserForm').find('input[name="setUserPassword'+id+'"]').val();
            
            var p = ',privilege=';
            var k = 0;
            $('#setUser'+id+' #setU'+id+'  input[type="checkbox"]:checked').each ( function() {
                if(k > 0) {p +=';';}
                p+=$(this).val();
                k++;
            });
            r += p;
            //~ alert(p);
            //~ alert(r);
            webiopi().callMacro("setUserSave", [e(r)] );
        }
        function addUserSetup(){
            webiopi().callMacro("addUserSetup", '', getUserReload );
        }
        function delUserSetup(id){
            webiopi().callMacro("delUserSetup", id , getUserReload);
        }
        var getUserReload = function (macro, args, response) {
            getPage();
        }
        
        function setUserSave () {
            if ($('#setUserForm').find('input[name="password"]').val() != $('#setUserForm').find('input[name="confirmPassword"]').val()) {
                alert("Le password non coincidono. Riprovare");
                return;
            }                
            var r = '';
            r += 'id=' + $('#setUserForm').find('input[name="id"]').val();
            r += ',username='+$('#setUserForm').find('input[name="username"]').val();
            r += ',password='+$('#setUserForm').find('input[name="password"]').val();
            r += ',name='+$('#setUserForm').find('input[name="name"]').val();
            r += ',surname='+$('#setUserForm').find('input[name="surname"]').val();
            r += ',session='+$('#setUserForm').find('input[name="session"]').val();
            r += ',lang='+$('#setUserForm').find('select[name="lang"]').val() ;
            
            var p = ',privilege=';
            var k = 0;
            $('#setUserForm').find('input[type="checkbox"]:checked').each ( function() {
                if(k > 0) {p += ';';}
                p += $(this).val();
                k++;
            });
            webiopi().callMacro("setUserSave", [e(r+p)] , setUserSave1);
        }
        
        var setUserSave1 = function(macro, args, response){
            setCookies('page','userSetup');
            getPage(1);
        }
        //Fine userSetup
        
        //Pagine setupArea
        var setArea = function (macro, args, response) {
            res = eval(response);
            var f = '<form name="setUserForm" id="setAreaForm">';
            f +=    '<table align=center width=100%><tr><th>Name</th><th>Description</th><th></th></tr>';
            for (r in res) {
                f += '<input type="hidden" name="id['+ res[r]['id'] +']" value="'+ res[r]['id'] +'" />';
                f += '<td><input type="text" name="name['+ res[r]['id'] +']" value="'+ res[r]['name'] +'" style="width:100px;" /></td>';
                
                f += '<td><input type="text" name="description['+ res[r]['id'] +']" value="'+ L(res[r]['description']) +'"  /></td>';
                
                f += '<td><input type="button" id="valida" name="valida" value="'+L('save')+'" onclick=setAreaSave(res[r]["id"]); /> ';
                f += '<input type="button" id="delete" name="delete" value="'+L('delete')+'" onclick=delAreaSave(res[r]["id"]); /> ';
                f += '</td></tr>';
            }
            f += '<tr><td colspan=3><input type="button" id="add" name="add" value="'+L('add')+'" onclick=setAreaAdd(); /></td></tr> ';                
            f +=        '</table>';
            f += '</form>'; 
            $("#form").html(f);
        }
        
        function setAreaSave(x) {
            var r = '';
            r += 'id='+$('#setAreaForm').find('input[name="id['+x+']"]').val();
            r += ',name='+$('#setAreaForm').find('input[name="name['+x+']"]').val();
            r += ',description='+$('#setAreaForm').find('input[name="description['+x+']"]').val();
            webiopi().callMacro("setAreaSave", [r] , setAreaSave1);
        }
        
        function setAreaSave1() {
            setCookies('page','areaSetup');
            getPage(1);
        }
        
        function delAreaSave(x) {
            webiopi().callMacro("delAreaSave", [x] );
            setCookies('page','areaSetup');
            getPage(1);
        }
        
        function setAreaAdd(){
            webiopi().callMacro("setAreaAdd",  '' );
            setCookies('page','areaSetup');
            getPage(1);
        }
        //Fine pagina setupArea

        //Pagine Lang setup
        var getLang = function (macro, args, response) {
            //~ alert(response);
            res = eval(response);
            
            var f = '<form name="getLangForm" id="getLangForm">';
            f +=    '<table class="f-h" align=center><tr><th>Tag</th><th>Language</th><th></th></tr>';
            for (r in res) {
                //~ $("#text").html(r + ' - ' + res[r]['name'] + '<br>'); 
                f += '<input type="hidden" name="id['+ res[r]['id'] +']" value="'+ res[r]['id'] +'" />';
                f += '<td><input type="text" name="tag['+ res[r]['id'] +']" value="'+ d(res[r]['tag']) +'"  size=10 readonly /></td>';
                f += '<td style="text-align:left;"><input type="text" name="en['+ res[r]['id'] +']" value="'+ d(res[r]['en']) +'" size=14 />EN<br />';
                f += '<input type="text" name="it['+ res[r]['id'] +']" value="'+ d(res[r]['it']) +'" size=14 />IT </td>';
                f += '<td><input type="button" id="valida" name="valida" value="Save" onclick=langSave('+res[r]["id"]+'); /> ';
                f += '<input type="button" id="delete" name="delete" value="Delete" onclick=langDelete('+res[r]["id"]+'); /> ';
                
                f += '</td></tr>';
            }
            f += '<tr><td colspan=3><input type="button" id="add" name="add" value="Add" onclick=langAdd(); /></td></tr> ';                
            f += '</table>';
            f += '</form>'; 
            $("#form").html(f);
            
        
        }
        function langSave(id) {
            var r = '';
            r += 'id='+$('#getLangForm').find('input[name="id['+id+']"]').val();
            r += ',tag='+$('#getLangForm').find('input[name="tag['+id+']"]').val();
            r += ',en='+$('#getLangForm').find('input[name="en['+id+']"]').val();
            r += ',it='+$('#getLangForm').find('input[name="it['+id+']"]').val();
            webiopi().callMacro("langSave", [r] );
            //~ setCookies('page','langSetup');
            getPage(1);
        }
                
        function langDelete(id) {
            webiopi().callMacro("langDelete", [id] );
            //~ setCookies('page','langSetup');
            getPage(1);
        }
        
        function langAdd(tag){
            webiopi().callMacro("langAdd",  tag, langAddOK );
            //~ setCookies('page','langSetup');
            
        }
        
        var langAddOK = function(macro, args, response){
			getPage(1);
		}
        
        //Fine pagina Lang Setup


        //Pagine setupPrivilege
        var setPrivilege = function (macro, args, response) {
            res = eval(response);
            var f = '<form name="setPrivilegeForm" id="setPrivilegeForm">';
            f +=    '<table class="f-h" align=center><tr><th>Name</th><th>Description</th><th>Save</th><th></th></tr>';
            for (r in res) {
                //~ $("#text").html(r + ' - ' + res[r]['name'] + '<br>'); 
                f += '<input type="hidden" name="id['+ res[r]['id'] +']" value="'+ res[r]['id'] +'" />';
                f += '<td><input type="text" name="name['+ res[r]['id'] +']" value="'+ d(res[r]['name']) +'" readonly /></td>';
                f += '<td><input type="text" name="description['+ res[r]['id'] +']" value="'+ d(res[r]['description']) +'"  /></td>';
                f += '<td><input type="button" id="valida" name="valida" value="Save" onclick=setPrivilegeSave('+res[r]["id"]+'); /> ';
                //~ f += '<input type="button" id="delete" name="delete" value="Delete" onclick=delPrivilegeSave('+res[r]["id"]+'); /> ';
                
                f += '</td></tr>';
            }
            //~ f += '<tr><td colspan=3><input type="button" id="add" name="add" value="Add" onclick=setPrivilegeAdd(); /></td></tr> ';                
            f +=        '</table>';
            f += '</form>'; 
            //~ alert(f);
            $("#form").html(f);
        }

        function setPrivilegeSave(x) {
            //~ alert(document.cookie);
            setCookies('page','privilegeSetup');
            var r = '';
            r += 'id='+$('#setPrivilegeForm').find('input[name="id['+x+']"]').val();
            r += ',name='+$('#setPrivilegeForm').find('input[name="name['+x+']"]').val();
            r += ',description='+$('#setPrivilegeForm').find('input[name="description['+x+']"]').val();
            webiopi().callMacro("setPrivilegeSave", [r] , setPrivilegeSave1);
        }
        
        function setPrivilegeSave1() {
            getPage(1);
        }
        
        function delPrivilegeSave(x) {
            webiopi().callMacro("delPrivilegeSave", [x] );
            getPage(1);
        }
        
        function setPrivilegeAdd(){
            webiopi().callMacro("setPrivilegeAdd",  '' );
            setCookies('page','privilegeSetup');
            getPage(1);
        }
        //Fine pagina Privilege

        //Pagina inputSetup
        var setInputSetup = function (macro, args, response) {
            res = eval(response);
            var f = '<form name="setInputSetupForm" id="setInputSetupForm">';
            f +=    '<div class="fieldSet">';
            f +=        '<fieldset>';
            f +=            '<legend>Form Input Setup</legend>';
            f +=            '<table class="f-h" align=center><tr><th>Name</th><th>Description</th><th>Save</th><th></th></tr>';
            for (r in res) {
                //~ $("#text").html(r + ' - ' + res[r]['name'] + '<br>'); 
                f += '<input type="hidden" name="id['+ res[r]['id'] +']" value="'+ res[r]['id'] +'" />';
                f += '<td><input size="1" type="text" name="name['+ res[r]['id'] +']" value="'+ res[r]['name'] +'" readonly /></td>';
                f += '<td><input size="30" type="text" name="description['+ res[r]['id'] +']" value="'+ res[r]['description'] +'"  /></td>';
                f += '<td><input type="button" id="valida" name="valida" value="Save" onclick=setInputSetupSave('+res[r]["id"]+'); /> ';
                //~ f += '<input type="button" id="delete" name="delete" value="Delete" onclick=delPrivilegeSave('+res[r]["id"]+'); /> ';
                
                f += '</td></tr>';
            }
            //~ f += '<tr><td colspan=3><input type="button" id="add" name="add" value="Add" onclick=setInputSetupAdd(); /></td></tr> ';                
            f +=        '</table>';
            f +=        '</fieldset>';
            f +=    '</div>';
            f += '</form>'; 
            //~ alert(f);
            $("#form").html(f);
        }

        function setInputSetupSave(x) {
            //~ alert(document.cookie);
            var r = '';
            r += 'id='+$('#setInputSetupForm').find('input[name="id['+x+']"]').val();
            r += ',name='+$('#setInputSetupForm').find('input[name="name['+x+']"]').val();
            r += ',description='+$('#setInputSetupForm').find('input[name="description['+x+']"]').val();
            webiopi().callMacro("setInputSetupSave", [r] );
            getPage(1)
        }
        
        function setInputSetupSave1() {
            setCookies('page','inputSetup');
            getPage(1);
        }
        
        function delInputSetupSave(x) {
            webiopi().callMacro("delInputSetupSave", [x] );
            setCookies('page','inputSetup');
            getPage(1);
        }
        
        function setInputSetupAdd(){
            webiopi().callMacro("setInputSetupAdd",  '' );
            setCookies('page','inputSetup');
            getPage(1);
        }
        //Fine pagina inputSetup

        //Pagine Type Function
        var setType = function (macro, args, response) {
            
            res = eval(response);
            var f = '<form name="setTypeForm" id="setTypeForm">';


            f +=            '<table class="f-h" align=center><tr><th>Name</th><th>Description</th><th>Save</th><th></th></tr>';
            for (r in res) {
                //~ $("#text").html(r + ' - ' + res[r]['name'] + '<br>'); 
                f += '<input type="hidden" name="id['+ res[r]['id'] +']" value="'+ res[r]['id'] +'" />';
                f += '<td><input type="text" name="name['+ res[r]['id'] +']" value="'+ d(res[r]['name']) +'" readonly size=5 /></td>';
                f += '<td><input style="text-align:left;" type="text" name="description['+ res[r]['id'] +']" value="'+ d(res[r]['description']) +'"  size=35 /></td>';
                f += '<td><input type="button" id="valida" name="valida" value="Save" onclick=setTypeSave('+res[r]["id"]+'); /> ';
                //~ f += '<input type="button" id="delete" name="delete" value="Delete" onclick=delTypeSave('+res[r]["id"]+'); /> ';
                
                f += '</td></tr>';
            }
            //~ f += '<tr><td colspan=3><input type="button" id="add" name="add" value="Add" onclick=setTypeAdd(); /></td></tr> ';                
            f +=        '</table>';
            f +=    '</div>';
            f += '</form>'; 
            //~ alert(f);
            $("#form").html(f);
        }

        function setTypeSave(x) {
            //~ alert(document.cookie);
            var r = '';
            r += 'id='+$('#setTypeForm').find('input[name="id['+x+']"]').val();
            r += ',name='+$('#setTypeForm').find('input[name="name['+x+']"]').val();
            r += ',description='+$('#setTypeForm').find('input[name="description['+x+']"]').val();
            webiopi().callMacro("setTypeSave", [r] , setTypeSave1);
        }
        
        function setTypeSave1() {
            setCookies('page','typeSetup');
            getPage(1);
        }
        
        function delTypeSave(x) {
            webiopi().callMacro("delTypeSave", [x] );
            setCookies('page','typeSetup');
            getPage(1);
        }
        
        function setTypeAdd(){
            webiopi().callMacro("setTypeAdd",  '' );
            setCookies('page','typeSetup');
            getPage(1);
        }
        //Fine pagina Type Function

        //Pagine boardTypeSetup
        var boardTypeSetup = function (macro, args, response) {
            res = eval(response);
            var f = '<form name="boardTypeForm" id="boardTypeForm">';
            f +=    '<table class="f-h" align=center><tr><th>ID</th><th>Name</th><th>Description</th><th></th></tr>';
            for (r in res) {
                //~ $("#text").html(r + ' - ' + res[r]['name'] + '<br>'); 
                f += '<input type="hidden" name="id['+ res[r]['id'] +']" value="'+ res[r]['id'] +'" />';
                f += '<td><input type="text" name="name['+ res[r]['id'] +']" value="'+ res[r]['name'] +'" style="width:100px;"  /></td>';
                f += '<td><input type="text" name="description['+ res[r]['id'] +']" value="'+ L(res[r]['description']) +'"  /></td>';
                f += '<td><input type="button" id="valida" name="valida" value="Save" onclick=saveBoardType('+res[r]["id"]+'); /> ';
                f += '<input type="button" id="delete" name="delete" value="Delete" onclick=delBoardType(res[r]["id"]); /> ';
                
                f += '</td></tr>';
            }
            f += '<tr><td colspan=3><input type="button" id="add" name="add" value="Add" onclick=addBoardType(); /></td></tr> ';                
            f +=        '</table>';
            f +=        '</fieldset>';
            f +=    '</div>';
            f += '</form>'; 
            $("#form").html(f);
        }
        
        function saveBoardType(id) {
            var r = '';
            r += 'id='+$('#boardTypeForm').find('input[name="id['+id+']"]').val();
            r += ',name='+$('#boardTypeForm').find('input[name="name['+id+']"]').val();
            r += ',description='+$('#boardTypeForm').find('input[name="description['+id+']"]').val();
            webiopi().callMacro("saveBoardType", [r] , saveBoardType1);
        }
        
        function saveBoardType1() {
            setCookies('page','boardTypeSetup');
            getPage(1);
        }
        
        function delBoardType(x) {
            webiopi().callMacro("delBoardType", [x] );
            setCookies('page','boardTypeSetup');
            getPage(1);
        }
        
        function addBoardType(){
            webiopi().callMacro("addBoardType",  '' );
            setCookies('page','boardTypeSetup');
            getPage(1);
        }
        //Fine pagina boardTypeSetup



        //Begin Board Setup
        var setBoardSetup = function (macro, args, response) {
            //~ alert(response);
            res = $.parseJSON(response);
            //~ res = eval(response);
            var f = '<form name="setBoardSetupForm" id="setBoardSetupForm">';
            f +=            '<table class="f-h" align=center><tr><th>Name</th><th>Description</th><th title="Board Address">Add</th><th title="Board Type">Type</th><th title="Board Enable">En</th><th>Save</th><th>IO</th></tr>';
            for (r in res['board']) {            
                //~ alert(res['board'][r]['name']);
                f += '<input type="hidden" name="id['+ res['board'][r]['id'] +']" value="'+ res['board'][r]['id'] +'" />';
                f += '<td><input type="text" size="4" name="name['+ res['board'][r]['id'] +']" value="'+ d(res['board'][r]['name']) +'" /></td>';
                f += '<td><input type="text" size="12" name="description['+ res['board'][r]['id'] +']" value="'+ d(res['board'][r]['description']) +'"  /></td>';
                f += '<td><input type="text" size="1" name="address['+ res['board'][r]['id'] +']" value="'+ res['board'][r]['address'] +'"  /></td>';
                
                f += '<td><select id="board_type" name="board_type['+ res['board'][r]['id'] +']" title="Select Board Type" >';
                var sel = '';
                for(bo in res['board_type']) {
                    var selected = '';
                    if( res['board'][r]['board_type'] == res['board_type'][bo]['id'] ){selected='selected=selected'; }
                    f += '<option value="'+res['board_type'][bo]['id']+'" '+selected+' >'+ res['board_type'][bo]['name'] +'</option>';
                }
                f += '</select></td>';
                
                var checked = '';
                if (res['board'][r]['enable'] == 1) {checked = 'checked="checked"'; }
                
                f += '<td><input type="checkbox" id="enable'+res['board'][r]['id']+'" name="enable['+ res['board'][r]['id'] +']" value="'+ res['board'][r]['enable'] +'" '+checked+'  /></td>';
                f += '<td><input type="button" id="valida" name="valida" value="Save" onclick=setBoardSetupSave('+res['board'][r]["id"]+'); /></td>';
                f += '<td><input type="button" id="addBoardIOSetupEdit" name="edit" value="Edit" onclick="setCookies(\'page\',\'boardIOSetup\','+res['board'][r]['id']+'); setCookies(\'board_id\','+res['board'][r]['id']+'); getPage('+res['board'][r]['id']+');" /></td>';
                f += '</tr>';
            }
            //~ f +=            '<tr><td colspan=6><input type="button" id="add" name="add" value="Add" onclick="addBoardSetup();"; /></td></tr> ';
            f +=        '</table>';
            f += '</form>'; 
            //~ alert(f);
            $("#form").html(f);
        }

        function setBoardSetupSave(id) {
            //~ alert(x);
            var r = '';
            
            r += 'id='+$('#setBoardSetupForm').find('input[name="id['+id+']"]').val();
            r += ',name='+$('#setBoardSetupForm').find('input[name="name['+id+']"]').val();
            r += ',description='+$('#setBoardSetupForm').find('input[name="description['+id+']"]').val();
            r += ',address='+$('#setBoardSetupForm').find('input[name="address['+id+']"]').val();
            var enable = $('#enable'+id).is(':checked') ? 1 : 0;
            r += ',enable=' + enable;
            
            var board_type_id = $('#setBoardSetupForm').find('select[name="board_type['+id+']"]').val() ;
            //~ alert(board_type_id); 
            r += ',board_type='+board_type_id ;
            
            //~ alert(r); 
            webiopi().callMacro("setBoardSetupSave", [r] , setBoardSetupSave1);
        }
        
        function setBoardSetupSave1() {
            setCookies('page','boardSetup');
            getPage(1);
        }
        
        function addBoardSetup(){
            webiopi().callMacro("addBoardSetup",  '' );
            getPage(1);
        }            
        //Fine BoardSetup

        //Board IO Setup           
        var setBoardIOSetup = function (macro, args, response) {
            var res = $.parseJSON(response);
            //~ alert(response);
            var bid = '';
            
            var f = '<form name="boardIOForm" id="boardIOForm"><table width=100%>';
            for(r in res['board_io']) {
                
                //mostra nome della board
                if( res['board_io'][r]['bid'] != bid ) {
                    //~ <caption style="font-weight:bold; background-color:#2952D8; color:white; margin-top:20px;">'+L('users_privileges')+'</caption>';
                    f += '<tr><th colspan=10 style="text-align:center; background-color:#2952D8; color:white; margin-top:20px;"> ID: '+res['board_io'][r]['bid']+ ' - Board name: ' +d(res['board_io'][r]['description'])+'</th></tr>';
                    f += '<tr><th>Board</th><th>I/O</th><th>Name</th><th>Description</th><th title="Input address">Add.</th><th title="Input enable">En.</th><th></th></tr>';
                    bid = res['board_io'][r]['bid'];
                }
                //~ f += '<div style="border:1px dashed gray; margin:5px; padding:5px;">';
                f += '<tr>'; 
                f += '<td><input id="id'+res['board_io'][r]['id']+'" type="hidden" name="id'+res['board_io'][r]['id']+'" value="'+res['board_io'][r]['id']+'" />';
                
                f += '<select id="board_id'+res['board_io'][r]['id']+'" name="board_id'+res['board_io'][r]['id']+'" title="Select Board IO" >';
                var sel = '';
                for(bo in res['board']) {
                    var selected = '';
                    if( res['board_io'][r]['board_id'] == res['board'][bo]['id'] ){selected='selected=selected';}
                    f += '<option value="'+res['board'][bo]['id']+'" '+selected+' >'+ res['board'][bo]['name'] +'</option>';
                }
                f += '</select></td>';
                
                f += '<td><select id="io_type_id'+res['board_io'][r]['id']+'" name="io_type_id'+res['board_io'][r]['id']+'" title="Select Input Type" >';
                var sel = '';
                for(io in res['io']) {
                    
                    var selected = '';
                    if( res['board_io'][r]['io_type_id'] == res['io'][io]['id'] ){selected='selected=selected';}
                    f += '<option value="'+res['io'][io]['id']+'" '+selected+' >'+ res['io'][io]['name'] +'</option>';
                }
                f += '</select></td>';
                f += '<td><input type="text" id="name'+res['board_io'][r]['id']+'" name="name'+res['board_io'][r]['id']+'" value="'+d(res['board_io'][r]['name'])+'" size="5" title="Name of Input" /></td>';
                f += '<td><input type="text" id="description'+res['board_io'][r]['id']+'" name="description'+res['board_io'][r]['id']+'" value="'+d(res['board_io'][r]['description'])+'" size="8" title="Description of Input" /></td>';
                f += '<td><input type="text" id="address'+res['board_io'][r]['id']+'" name="address'+res['board_io'][r]['id']+'" value="'+res['board_io'][r]['address']+'" size="1" title="Address of Input" /></td>';
                var checked='';
                if(res['board_io'][r]['enable'] == 1) {checked='checked=checked';}
                f += '<td><input type="checkbox" id="enable'+res['board_io'][r]['id']+'" name="enable'+res['board_io'][r]['id']+'" value="'+res['board_io'][r]['enable']+'" '+checked+' title="Input enable" /></td>';
                f += '<td><input type="button" name="save" value="Save" onclick="setCookies(\'page\',\'boardIOSetup\'); saveBoardIOSetup('+res['board_io'][r]['id']+');" />';
                f += '<input type="button" name="del" value="Del" onclick="setCookies(\'page\',\'boardIOSetup\'); delBoardIOSetup('+res['board_io'][r]['id']+');" /></td>';
                f += '</tr>';
                //~ f += '</div>';
            }
            //~ alert(JSON.stringify(getCookies()['board_id']));
            f += '<tr><td colspan=10 style="text-align:center;"><input type="button" id="add" name="add" value="Add input" onclick="addBoardIOSetup('+getCookies()['board_id']+');"; /></td></tr>';
            
            f += '</table></form>';
            //~ f += response;
            $("#form").html(f);
        }
        
        function saveBoardIOSetup(id) {
            var r = '';
            r += 'id='+$('#boardIOForm').find('input[name="id'+id+'"]').val();
            r += ',board_id='+$('#boardIOForm').find('select[name="board_id'+id+'"]').val() ;
            r += ',io_type_id='+$('#boardIOForm').find('select[name="io_type_id'+id+'"]').val() ;
            r += ',name='+$('#boardIOForm').find('input[name="name'+id+'"]').val();
            r += ',description='+$('#boardIOForm').find('input[name="description'+id+'"]').val();
            r += ',address='+$('#boardIOForm').find('input[name="address'+id+'"]').val();
            
            var enable = $('#boardIOForm').find('input[name="enable'+id+'"]:checkbox:checked').val() ? '1':'0';
            r += ',enable='+enable;
            //~ alert(r);
            webiopi().callMacro("saveBoardIOSetup", [r] );
            getPage(1);
        }
        
        function addBoardIOSetup(id) {
            webiopi().callMacro("addBoardIOSetup",  id );
            getPage(1);
        }
        
        function delBoardIOSetup(id) {
            webiopi().callMacro("delBoardIOSetup", [id] );
            getPage(1);
        }
        //~ END BoardIOSetup
        
        //Function Setup           
        var programSetup = function (macro, args, response) {
            var res = $.parseJSON(response);
            var f = '';
            f += '<form name="programSelectForm" id="programSelectForm">'; 
            f += '<center><select id="id" name="id" title="Select Program" >';
            for(r in res['program']) {
                var selected='';
                //~ if( res['program'][r]['board_id'] == res['board'][bo]['id'] ){selected='selected=selected';}
                f += '<option value="'+res['program'][r]['id']+'" '+selected+' >'+ d(res['program'][r]['name']) +' '+d(res['program'][r]['description'])+'</option>';
            }
            f += '</select>';
            f += '<input type="button" name="edit" value="'+L('edit')+'" onclick="setCookies(\'page\',\'programSetup\'); editProgramSetup();" />';
            f += '<input type="button" id="add" name="add" value="'+L('add_program')+'" onclick="addProgramSetup();"; />';
            f += '</center></form>';
            $("#form").html(f);
        }
        
        function editProgramSetup(id) {
            var r = $('#programSelectForm').find('select[name="id"]').val() ;
            webiopi().callMacro("getProgramSetup",  [r],  getProgramSetup);
            getPage(1);
        }

        
        function addProgramSetup() {
            webiopi().callMacro("addProgramSetup",  '' );
            getPage(1);
        }            

        var getProgramSetup = function (macro, args, response) {
            var res = $.parseJSON(response);
            window.globalVar = res;
            var f = "";
            f += '<form name="ProgramSetupForm" id="ProgramSetupForm">'; 
            f += '<table width=100%><tr><td id="title" colspan=2>'+L('program_Setup_n.')+' '+res['program'][0]['id']+'  '+ L(res['program'][0]['name']) + '</td></tr>';
            f += '<input id="id" type="hidden" name="id" value="'+ res['program'][0]['id'] +'" />';
            f += '<tr><td>Name: <input type="text" id="name" name="name" value="'+d(res['program'][0]['name'])+'" size=8 title="Name of program" /></td>';
            f += '<td>Description: <input type="text" id="description" name="description" value="'+d(res['program'][0]['description'])+'" size=10 title="Description of program" /></td>';
            
            var enable='';
            if(res['program'][0]['enable'] == 1) {enable='checked=checked';}
            f += '<td>Enable: <input type="checkbox" id="enable" name="enable" value="'+res['program'][0]['enable']+'" '+enable+' title="Select for program enables" /></td></tr>';
            
            
            f += '<tr><td colspan=2>Type of program: <select id="type" name="type" title="Select Type Function" onChange="getType();">';
            for(r in res['type']) {
                var type_selected = '';
                if( res['type'][r]['id'] == res['program'][0]['type_id'] ){type_selected='selected=selected';}
                f += '<option value="'+res['type'][r]['id']+'" '+type_selected+' title="Select Type Function" >'+ d(res['type'][r]['name']) + ' </option>';
            }
            f += '</select></td></tr></table>'; 
            
            f += '<table width=100% style="border:1px solid gray; margin:5px; padding: 5px;" ><tr><td>Input</td><td>Inv.</td><td>Output</td><td>Save</td><td>Delete</td></tr>';
            f += '<tr><td>';
            
            //Input select
            f += '<select class="program_input" id="in" name="in" title="Select Input" >';
            for(r in res['in']) {
                
                //Colored the used input
                var style1=''
                for(r1 in res['program_all']) {
                    if(res['program_all'][r1]['in_id']==res['in'][r]['id']){style1='style="color:red; font-weight:bold;"'; }
                }
                var in_selected = '';
                if( res['in'][r]['id'] == res['program'][0]['in_id'] ){in_selected='selected=selected';}
                f += '<option '+style1+' value="'+res['in'][r]['id']+'" '+in_selected+' title="Select Input" >'+res['in'][r]['bname']+ ' ' + res['in'][r]['name'] +  '</span></option>';
            }
            f += '</select>';
            f += "</td><td>";
                        
            var in_checked='';
            if(res['program'][0]['inverted'] == 1) {in_checked='checked=checked';}
            f += '<input type="checkbox" id="inverted" name="inverted" value="'+res['program'][0]['inverted']+'" '+in_checked+' title="Select for inverted Input" />';
        
            f += "</td>";
            //~ f += '<td><input type="text" id="in_delay" name="in_delay" value="'+res['program'][0]['in_delay']+'" size="1" title="Input delay" /></td>';
            //Output select
            f += '<td><select id="out" name="out" title="Select Output" >';
            for(r in res['out']) {
                var out_selected = '';
                //Colored the used output and selected
                for(r1 in res['program_all']) {
                    if(res['program'][0]['out_id']==res['out'][r]['id']){var style1='style="color:gray; font-weight:bold;"'; out_selected='selected=selected';}
                    else if(res['program_all'][0]['out_id']==res['out'][r]['id']){var style1='style="color:red; font-weight:bold;"'; }
                    else{var style1='style="color:green;font-weight:bold;"';}
                }
                f += '<option '+style1+' value="'+res['out'][r]['id']+'" '+out_selected+' title="Select Output" >'+ res['out'][r]['bname'] + ' ' + res['out'][r]['name'] + ' </option>';
            }
            f += '</select></td>';                
            
            f += '<td><input type="button" name="save" value="Save" onclick="setCookies(\'page\',\'programSetup\'); saveProgramSetup();" /></td>';
            f += '<td><input type="button" name="delete" value="Delete" onclick="setCookies(\'page\',\'programSetup\'); deleteProgramSetup('+res['program'][0]['id']+');" /></td>';
            f += '</table></form>';
            $("#form1").html(f);
            getType();
        }
        
        function getType(){
            var res = window.globalVar;
            var type = $( "#type option:selected" ).val();
            //~ alert(JSON.stringify(res['program'][0]['timer']));
            //~ alert(eval(res['program'][0]['timer'])[1]);
            var f = '';
            switch (type) {
                case '1':
                break;
                case '2':
                    var t = res['program'][0]['timer'];
                    t = t.split(';'); 
                    f += '<center id="ntype"><p><h3>Insert timer Time (days - hours - minutes - seconds)</h3>';
                    f += 'D:<input type="number" min="0" max="30" step="1" value="'+(t[0] == '' ? 0 : t[0])+'" name="day" id="day" style="width:50px;" /> ';
                    f += 'H:<input type="number" min="0" max="23" step="1" value="'+(t[1] == '' ? 0 : t[1])+'" name="hour" id="hour" style="width:50px;" /> ';
                    f += 'M:<input type="number" min="0" max="59" step="1" value="'+(t[2] == '' ? 0 : t[2])+'" name="minute" id="minute" style="width:50px;" /> ';
                    f += 'S:<input type="number" min="0" max="59" step="1" value="'+(t[3] == '' ? 0 : t[3])+'" name="second" id="second" style="width:50px;" /> ';
                    f += '</p></center>';
                break;
                case '3':
                    f += '<center id="ntype"><p><h3>Insert interval (hours - minutes - seconds)</h3>';
                    var c = res['program'][0]['chrono'];
                    c = c.split(';');
                    //~ alert(c.length);
                    for(i = 0; i<c.length;) {
                        f += 'From: <input type="number" min="0" max="23" step="1" value="'+c[i++]+'" name="ch'+i+'" id="ch" style="width:40px;" /> ';
                        f += '<input type="number" min="0" max="59" step="1" value="'+c[i++]+'" name="ch'+i+'" id="ch" style="width:40px;" /> ';
                        f += '<input type="number" min="0" max="59" step="1" value="'+c[i++]+'" name="ch'+i+'" id="ch"  style="width:40px;" /> ';
                        f += 'To: <input type="number" min="0" max="23" step="1" value="'+c[i++]+'" name="ch'+i+'" id="ch"  style="width:40px;" /> ';
                        f += '<input type="number" min="0" max="59" step="1" value="'+c[i++]+'" name="ch'+i+'" id="ch"  style="width:40px;" /> ';
                        f += '<input type="number" min="0" max="59" step="1" value="'+c[i++]+'" name="ch'+i+'" id="ch"  style="width:40px;" /> ';
                        f += '<input type="button" id="clear" name="clear" value="Clear" onclick="clearInput('+i+');" /><br>'
                        
                    }
                    f += '</table>';
                    f += '</p></center>';
                break;
                case '4':
                    //~ $( "#form1" ).append( "<p>Remote</p>" ); 
                break;
            }
            $( "#ntype" ).remove(); 
            $( "#ProgramSetupForm" ).append(f); 
            return f;
        }
        
        function clearInput(i){
            //~ $('#ProgramSetupForm').find('input[name="ch'+i+'"]').val(99);
            $( 'input[name="ch'+i+'"]' ).text(9)
            //~ alert($('#ch').find('input[name="ch'+i+'"]').val());
            $('#ProgramSetupForm').find('input[name="ch'+i+'"]').val(0);
            $('#ProgramSetupForm').find('input[name="ch'+--i+'"]').val(0);
            $('#ProgramSetupForm').find('input[name="ch'+--i+'"]').val(0);
            $('#ProgramSetupForm').find('input[name="ch'+--i+'"]').val(0);
            $('#ProgramSetupForm').find('input[name="ch'+--i+'"]').val(0);
            $('#ProgramSetupForm').find('input[name="ch'+--i+'"]').val(0);
        }
        
        function saveProgramSetup() {
            var r = '';
            r += 'id='+$('#ProgramSetupForm').find('input[name="id"]').val();
            r += ',name='+$('#ProgramSetupForm').find('input[name="name"]').val();
            r += ',description='+$('#ProgramSetupForm').find('input[name="description"]').val();
            
            var enable=$('#enable').is(':checked') ? '1':'0';
            r += ',enable='+enable;
            
            r += ',in_id='+$('#ProgramSetupForm').find('select[name="in"]').val() ;
            var inverted=$('#inverted').is(':checked') ? '1':'0';
            r += ',inverted='+inverted;
            //~ r += ',in_delay='+$('#ProgramSetupForm').find('input[name="in_delay"]').val();
            r += ',out_id='+$('#ProgramSetupForm').find('select[name="out"]').val() ;
            var type_id = $('#ProgramSetupForm').find('select[name="type"]').val() ;
            r += ',type_id='+type_id ;
            
            //~ Timer value
            if(type_id=="2") {                    
                var timer = ',timer=';
                timer += $('#ProgramSetupForm').find('input[name="day"]').val()+';';
                timer += $('#ProgramSetupForm').find('input[name="hour"]').val()+';';
                timer += $('#ProgramSetupForm').find('input[name="minute"]').val()+';';
                timer += $('#ProgramSetupForm').find('input[name="second"]').val()+'';
                r += timer;
            }
            //~ Chrono value
            if(type_id=="3") {
                var c=',chrono=';
                for (i=1; i<61; i++){
                    if ( $('#ProgramSetupForm').find('input[name="ch'+i+'"]').val() != undefined ){var chval= $('#ProgramSetupForm').find('input[name="ch'+i+'"]').val();}
                    else {var chval='';}
                    
                    c += chval;
                    if(i<60){c += ';';}
                }
                r += c;
            }
            
            //~ alert(r)
            webiopi().callMacro("saveProgramSetup", [r] );
            getPage(1);
        }
        
        function deleteProgramSetup(id) {
            webiopi().callMacro("deleteProgramSetup",  id);
            getPage(1);
        }
                    
        //Encode characters
        function e(str) {return encodeURI(str); }
        
        //Decode characters
        function d(str) {return decodeURIComponent(str);}
        
        //~ multipleValues.join( ", " )
    </script> 
</head>
<body>

<div id="container">
    <div id="title"></div>
    <div id="user"></div>
    
    <div id="login"></div>
    
    <div id="pages"></div>
    <div id="form"></div>
    <div id="form1"></div>
    <div id="text"></div>
    <div id="message"></div>
    <div id="footer"></div>
    <div id="datetime"></div>
    <div id="dialog"></div>

</div>

</body>
</html>
