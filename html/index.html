<!DOCTYPE html>
<html>
<head>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
    <title>Domus Control</title>
    <link href="./css/style.css" rel="stylesheet" type="text/css">
    <script type="text/javascript" src="/webiopi.js"></script>

    <script type="text/javascript"> 

        //Ciclo principale
        webiopi().ready(
            function() {
                
                
                
                getPage();
                
                webiopi().refreshGPIO();
            });
            // Fine main ciclo
            
            //Funzione che trasforma i cookie in array
            function getCookies() {
                var cookies = { }; 
                if (document.cookie && document.cookie != '') {
                    var split = document.cookie.split(';');
                    for (var i = 0; i < split.length; i++) {
                        var name_value = split[i].split("=");
                        name_value[0] = name_value[0].replace(/^ /, '');
                        cookies[decodeURIComponent(name_value[0])] = decodeURIComponent(name_value[1]);
                    }
                }	  
                return cookies;   
            }                
            
            //Sceglie quali pagine mostrare
            function getPage() {
                var title;
                var footer;
                var page = getCookies()['page'];
                if(typeof(page) == 'undefined' ) {page = "login";} //init if page is not set
                //~ alert(document.cookie);
               
                switch(page) {
                    case 'login':
                        page = '<small>Login</small>'
                        footer = '<span>Inserisci username e password</span>';
                        var l = '<form style="border: 1px solid green; padding: 10px; margin: 10px;" id="login">' + 
                             '<center><input id="username" type=text name="username" value="" required autofocus placeholder="Username" > </center>' +
                                '<center><input id="password" type=password name="password" value="" required placeholder="Password"></center>' +
                                '<center><input id="entra" type="button" name="entra" value="Entra" onclick=Login();></center>' +
                            '</form>';
                        $("#form").html(l);
                        break;
                    case 'menu':    
                        title = '<small>Menu</small>'
                        footer = '<span><input type="button" name="footer" value="LogOut" onclick=LogOut() ></span>' ;
                        footer += '<span>Benvenuto ' + getCookies()["username"] + '</span>';   
                        $("#form").html('<p class="but"><input type="button" name="status" value="Status" onclick="document.cookie=\'page=menuStatus\';getPage()" ></p>' +
                                '<p class="but"><input type="button" name="setup" value="Setup" onclick="document.cookie=\'page=menuSetup\';getPage()" ></p>');                  
                        break;
                    case 'menuSetup':
                        title = '<small>Menu Setup</small>';
                        footer = '<span><input type="button" name="footer" value="LogOut" onclick=LogOut() ></span>' ;
                        footer += '<span><input type="button" name="footer" value="Main Menu" onclick="document.cookie=\'page=menu\';getPage()" ></span>' ;
                        footer += '<span>Benvenuto ' + getCookies()["username"] + '</span>';
                        $("#form").html( '<p class="but"><input type="button" name="setup" value="User Setup" onclick="document.cookie=\'page=userSetup\';getPage()" ></p>' +
                            '<p class="but"><input type="button" name="setup" value="Area Setup" onclick="document.cookie=\'page=areaSetup\';getPage()" ></p>' +
                            '<p class="but"><input type="button" name="setup" value="Group Privileges" onclick="document.cookie=\'page=groupPrivileges\';getPage()" ></p>' +
                            '<p class="but"><input type="button" name="setup" value="Setup Devices" onclick="document.cookie=\'page=deviceSetup\';getPage()" ></p>' +
                            '<p class="but"><input type="button" name="setup" value="Input Setup" onclick="document.cookie=\'page=inputSetup\';getPage()" ></p>' +
                            '<p class="but"><input type="button" name="setup" value="Area Setup" onclick="document.cookie=\'page=areaSetup\';getPage()" ></p>' +
                            '<p class="but"><input type="button" name="setup" value="Email - SMS Setup" onclick="document.cookie=\'page=email-smsSetup\';getPage()" ></p>' );
                        break;
                    case 'userSetup':
                        title = '<small>User Setup</small>';
                        footer = '<span><input type="button" name="footer" value="LogOut" onclick=LogOut() ></span>' ;
                        footer += '<input type="button" name="setup" value="Menu Setup" onclick="document.cookie=\'page=menuSetup\';getPage()" >';
                        footer += '<span>Benvenuto ' + getCookies()["username"] + '</span>';
                        $("#form").html('')
                        break;                        
                    case 'areaSetup':
                        title = '<small>Area Setup</small>';
                        footer = '<span><input type="button" name="footer" value="LogOut" onclick=LogOut() ></span>' ;
                        footer += '<input type="button" name="setup" value="Menu Setup" onclick="document.cookie=\'page=menuSetup\';getPage()" >';
                        footer += '<span>Benvenuto ' + getCookies()["username"] + '</span>';
                        $("#form").html('')
                        break;                        
                    case 'groupPrivileges':
                        title = '<small>Group Privileges Setup</small>';
                        footer = '<span><input type="button" name="footer" value="LogOut" onclick=LogOut() ></span>' ;
                        footer += '<input type="button" name="setup" value="Menu Setup" onclick="document.cookie=\'page=menuSetup\';getPage()" >';
                        footer += '<span>Benvenuto ' + getCookies()["username"] + '</span>';
                        $("#form").html('')
                        break;   
                    case 'deviceSetup':
                        title = '<small>Device Setup</small>';
                        footer = '<span><input type="button" name="footer" value="LogOut" onclick=LogOut() ></span>' ;
                        footer += '<input type="button" name="setup" value="Menu Setup" onclick="document.cookie=\'page=menuSetup\';getPage()" >';
                        footer += '<span>Benvenuto ' + getCookies()["username"] + '</span>';
                        $("#form").html('')
                        break;                        
                    case 'inputSetup':
                        title = '<small>Input Setup</small>';
                        footer = '<span><input type="button" name="footer" value="LogOut" onclick=LogOut() ></span>' ;
                        footer += '<input type="button" name="setup" value="Menu Setup" onclick="document.cookie=\'page=menuSetup\';getPage()" >';
                        footer += '<span>Benvenuto ' + getCookies()["username"] + '</span>';
                        $("#form").html('')
                        break;  
                    case 'areaSetup':
                        title = '<small>Area Setup</small>';
                        footer = '<span><input type="button" name="footer" value="LogOut" onclick=LogOut() ></span>' ;
                        footer += '<input type="button" name="setup" value="Menu Setup" onclick="document.cookie=\'page=menuSetup\';getPage()" >';
                        footer += '<span>Benvenuto ' + getCookies()["username"] + '</span>';
                        $("#form").html('')
                        break;
                    case 'email-smsSetup':
                        title = '<small>Email - SMS Setup</small>';
                        footer = '<span><input type="button" name="footer" value="LogOut" onclick=LogOut() ></span>' ;
                        footer += '<input type="button" name="setup" value="Menu Setup" onclick="document.cookie=\'page=menuSetup\';getPage()" >';
                        footer += '<span>Benvenuto ' + getCookies()["username"] + '</span>';
                        $("#form").html('')
                        break;
                    case 'menuStatus':
                        title = '<small>Status</small>';
                        footer = '<span><input type="button" name="footer" value="LogOut" onclick=LogOut() ></span>' ;
                        footer += '<input type="button" name="setup" value="Menu" onclick="document.cookie=\'page=menu\';getPage()" >';
                        footer += '<span>Benvenuto ' + getCookies()["username"] + '</span>';
                        $("#form").html('')
                        break;
                    default:
                        footer = '<span><input type="button" name="footer" value="LogOut" onclick=LogOut() ></span>' ;
                } 
                
                $("#title").html('<h1>DomoControl - ' + title + '</h1>');
                $("#footer").html(footer);
            }
            
            //verifica se le credenziali sono corrette
            function Login() {
                if($("#username").val() && $("#password").val()) {
                    webiopi().callMacro("setLogin", [$("#username").val(),$("#password").val()], setLogin);
                }
                else {
                    alert("Inserisci i campi Username e Password");
                }
            } 
            
            var setLogin = function (macro, args, response) {
                if(response == "Login_NO") {
                    alert("Username e Password non validi");    
                } else {
                    var res = $.parseJSON(response)[0];
                    document.cookie = "username = " +res ['username'];
                    document.cookie = "name = " +res['name'];
                    document.cookie = "surname = " +res['surname'];
                    document.cookie = "piLogin = Yes";
                    document.cookie = "page = menu";
                    getPage();
                }
                
            }
            
            //rimuove i cookie e logout
            function LogOut() {
                document.cookie = "username=; expires=Thu, 01 Jan 1970 00:00:00 UTC";
                document.cookie = "piLogin=; expires=Thu, 01 Jan 1970 00:00:00 UTC";
                document.cookie = "page=login";
                getPage();
            }
            


    </script> 
</head>
<body>


<div id="container">
    <div id="title" class="title"></div>
    <div id="user"></div>
    
    <div id="login"></div>
    
    <div id="pages"></div>
    <div id="form"></div>
    <div id="menu"></div>
    <div id="message"></div>
    <div id="footer"></div>
    

</div>




</body>
</html>
