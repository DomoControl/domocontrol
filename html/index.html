<!DOCTYPE html>
<html>
<head>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
    <title>Domus Control</title>
    <link href="./css/style.css" rel="stylesheet" type="text/css">
    <script type="text/javascript" src="/webiopi.js"></script>
    <script type="text/javascript"> 

        //Ciclo principale
        webiopi().ready(
            function() {
                
                getTitle(getCookies()["page"]); //imposta il titolo della pagina
                //Verifica se l'utente Ã¨ autenticato
                if (getCookies() && getCookies()["username"] != "undefined" && getCookies()["piLogin"] && getCookies()["piLogin"] == "Yes") {
                    if( getCookies()["page"] == "Menu" ) {
                        $("#form").append('<p><input type="button" name="status" value="Status" onclick="document.cookie=\'page=menuStatus\';location.reload()" ></p>');
                        $("#form").append('<p><input type="button" name="setup" value="Setup" onclick="document.cookie=\'page=menuSetup\';location.reload()" ></p>');
                    }
                    else if( getCookies()["page"] == "menuSetup" ) {
                        $("#form").append('<p><input type="button" name="status" value="Status" onclick="document.cookie=\'page=menuStatus\';location.reload()" ></p>');
                    }
                    else if( getCookies()["page"] == "menuStatus" ) {
                        alert("menu setup");
                    }                    
                    
                }
                //Login Page
                else if (! getCookies()["piLogin"] || getCookies()["piLogin"] == 'undefined') {
                    document.cookie = "page=Login";
                    var l = '<form style="border: 1px solid green; padding: 10px; margin: 10px;" id="login">' + 
                             '<center>Username: <input id="username" type=text name="username" value="" required autofocus placeholder="Username" > </center>' +
                                '<center>Password: <input id="password" type=password name="password" value="" required placeholder="Password"></center>' +
                                '<center><input id="entra" type="button" name="entra" value="Entra" onclick=Login();></center>' +
                            '</form>';
                    $("#form").append(l);
                }
                
                
                getFooter(getCookies()["page"]); //mostra il footer
                webiopi().refreshGPIO();
            });
            // Fine main ciclo
            
            //Funzione che trasforma i cookie in array
            function getCookies() {
                var cookies = { }; 
                if (document.cookie && document.cookie != '') {
                    var split = document.cookie.split(';');
                    for (var i = 0; i < split.length; i++) {
                        var name_value = split[i].split("=");
                        name_value[0] = name_value[0].replace(/^ /, '');
                        cookies[decodeURIComponent(name_value[0])] = decodeURIComponent(name_value[1]);
                    }
                }	  
                return cookies;   
            }                
            
            //Mostra il titolo della pagina
            function getTitle(page) {
                var title;
                switch(page) {
                    case 'Login':
                        break;
                    case 'Menu':                        
                        break;
                    case 'menuSetup':
                        page = 'Menu Setup';
                        break;
                    case 'menuStatus':
                        page = 'Status';
                        break;
                }
                $("#title").append('<h1>DomoControl - ' + page + '</h1>');
            }
            
            //Mostra il footer
            function getFooter(page) {    
                var footer;
                switch(page) {
                    case 'Login':
                        footer = '<span>Inserisci username e password</span>';
                        break;
                    case 'Menu':
                        footer = '<span><input type="button" name="footer" value="LogOut" onclick=LogOut() ></span>' ;
                        footer += '<span>Benvenuto ' + getCookies()["username"] + '</span>';        
                        break;
                    case 'menuSetup':
                        footer = '<span><input type="button" name="footer" value="LogOut" onclick=LogOut() ></span>' ;
                        footer += '<span>Benvenuto ' + getCookies()["username"] + '</span>';        
                        break;
                    case 'menuStatus':
                        footer = '<span><input type="button" name="footer" value="LogOut" onclick=LogOut() ></span>' ;
                        footer += '<span>Benvenuto ' + getCookies()["username"] + '</span>';        
                        break;                        
                }
                $("#footer").append(footer);
            }            
            
            //verifica se le credenziali sono corrette
            function Login() {
                if($("#username").val() && $("#password").val()) {
                    webiopi().callMacro("setLogin", [$("#username").val(),$("#password").val()], setLogin);
                }
                else {
                    alert("Inserisci i campi Username e Password");
                }
            } 
            
            var setLogin = function (macro, args, response) {
                if(response == "Login_NO") {
                    alert("Username e Password non validi");    
                } else {
                    var res = $.parseJSON(response)[0];
                    document.cookie = "username = " +res ['username'];
                    document.cookie = "name = " +res['name'];
                    document.cookie = "surname = " +res['surname'];
                    document.cookie = "piLogin = Yes";
                    document.cookie = "page = Menu";
                    location.reload();
                }
                
            }
            
            //rimuove i cookie e logout
            function LogOut() {
                document.cookie = "username=; expires=Thu, 01 Jan 1970 00:00:00 UTC";
                document.cookie = "piLogin=; expires=Thu, 01 Jan 1970 00:00:00 UTC";
                document.cookie = "page = Login";
                //location.reload();
            }
            


    </script> 
</head>
<body>


<div id="container">
    <div id="title" class="title"></div>
    <div id="user"></div>
    
    <div id="login"></div>
    
    <div id="pages"></div>
    <div id="form"></div>
    <div id="menu"></div>
    <div id="message"></div>
    <div id="footer"></div>
    

</div>




</body>
</html>
